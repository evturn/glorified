"use strict";var RB={};RB.Note=Backbone.Model.extend({idAttribute:"_id"}),RB.Notes=Backbone.Collection.extend({model:RB.Note,url:"/notes",merge:!0}),RB.User=Backbone.Model.extend({idAttribute:"_id"}),_.extend(Backbone.View.prototype,{garbageTemplate:_.template($("#garbage-watcher-template").html()),allDoneTemplate:_.template($("#sunny-template").html()),collection:null,get:function(){var t=this,e=new RB.Notes;e.fetch({success:function(e){null===t.collection&&(app.collection=e,console.log(app.collection));var i=t.getLists(app.collection);t.setLists(i)},error:function(t){console.log(t)}})},post:function(t){var e=this,i=$(".note-input"),n=$(".active-notes-container");app.collection.create(t,{success:function(t,s){i.val("").focus(),app.validate();var o=new RB.NoteItem({model:t});n.append(o.render().el),e.onChangeListeners(),e.notify("Created")},error:function(t){console.log(t)}})},put:function(t,e,i){{var n=this,s=t.get("_id");t.get("list")}t.save(e,{url:"/notes/"+s,success:function(t,e){n.notify("Updated"),n.onChangeListeners(),i.render()},error:function(t){console.log(t)}})},destroy:function(t){var e=this,i=(t.get("list"),t.get("_id"));null!==i&&t.destroy({wait:!0,url:"/notes/"+i,dataType:"text",data:{_id:i},success:function(t){console.log("success ",t),e.notify("Removed"),e.onChangeListeners()},error:function(t){console.log("error ",t)}})},getNotesByListname:function(t){var e=this.collection.where({list:t});return e},getLists:function(){var t=[];return this.collection.each(function(e){var i=e.get("name");-1===t.indexOf(i)&&t.push(i)}),t},setLists:function(t){var e=t,i=_.template($("#list-name-template").html()),n=$(".lists-container");n.empty();for(var s=0;s<e.length;s++){var o=this.collection.where({list:e[s]}).length;n.append(i({name:e[s],length:o}))}},setNote:function(t){var e=$(".active-notes-container"),i=new RB.NoteItem({model:t});e.append(i.render().el)},setNotes:function(t,e){var i=$(".active-notes-container"),n=$(".active-input.list-input"),s=$(".active-input.note-input");if(e.length>0){var o=e[0].get("list");n.val(o);var a=this.tojquery(t);a.empty();for(var r=0;r<e.length;r++){var l=e[r],c=new RB.NoteItem({model:l});a.append(c.render().el)}this.resetActiveList(o)}else n.val(""),s.val(""),i.empty();this.isMobile()||s.focus()},setListValue:function(t){var e=$(".active-input.list-input");e.val(t)},resetActiveList:function(t){var e=$(".list-item"),i=$("div").find("[data-id='"+t+"']");return e.removeClass("active"),i.addClass("active"),i},getListnameContainer:function(t){var e=$("div").find("[data-id='"+t+"']");return e},notify:function(t){var e=$(".kurt-loader");e.html('<p class="thin-sm animated fadeIn">'+t+"</p>");var i=e.find(".thin-sm");setTimeout(function(){i.removeClass("animated fadeIn"),i.addClass("animated fadeOut")},1e3)},tojquery:function(t){switch(typeof t){case"object":if(t instanceof jQuery)return t;break;case"string":return $("."===t.charAt(0)?t:document.getElementsByClassName(t))}},convertDate:function(t){var e=new Date(t),i=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],n=(e.getFullYear(),e.getMonth()),s=e.getDate(),o=e.getHours(),a=e.getMinutes(),r=a>10?a:"0"+a,l=o>=12?"PM":"AM",c=o>12?o-12:o;n=(""+(n+1)).slice(-2);var u=i[e.getDay()]+" "+n+"/"+s+" "+c+":"+r+l;return u},init:function(){this.fixPath(),this.setActiveList(),this.deviceEnv(800),this.sunny(),this.setFirstChildActive(),this.isListSelected()},deviceEnv:function(t){this.isMobile()&&setTimeout(this.toggleLists,t)},isListSelected:function(){var t=$(".active-notes-container .list-item");if(t.length){var e=this.getCurrentList();return this.resetActiveList(e),!0}return!1},setFirstChildActive:function(){var t=$(".lists-container").first();t.addClass("active")},setActiveList:function(){$(document).on("click",".lists-container .list-item",function(){var t=$(".list-item");t.removeClass("active"),$(this).addClass("active"),$(document).trigger("listSelected")})},toggleLists:function(){var t=$(".lists-container"),e=$(".toggle-list-btn .fa");t.slideToggle("fast"),e.toggleClass("collapsed")},isMobile:function(){var t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return t},onChangeListeners:function(){var t=this.garbageWatcher();this.appendDoneStats(t),this.listWatcher(),this.isListSelected()},getCurrentList:function(){var t=$(".list-input").val();return t},garbageWatcher:function(){var t=this.getCurrentList(),e=app.collection.where({list:t,done:!0}).length;return e},appendDoneStats:function(t){{var e=$(".garbage-container");$(".garbage-container .stat"),$(".garbage-container .edit")}return e.html(0!==t?this.garbageTemplate({length:t}):this.allDoneTemplate()),this},listWatcher:function(){var t=_.template($("#list-name-template").html()),e=$(".lists-container"),i=$(".list-input").val(),n=this.resetActiveList(i),s=app.collection.where({list:i}).length;return $(n).remove(),s>0&&e.prepend(t({name:i,length:s})),this},sunny:function(){var t=0;setInterval(function(){$(".fa.fa-certificate").css({"-ms-transform":"rotate("+t+"deg)"}).css({"-moz-transform":"rotate("+t+"deg)"}).css({"-o-transform":"rotate("+t+"deg)"}).css({"-webkit-transform":"rotate("+t+"deg)"}).css({transform:"rotate("+t+"deg)"}),t+=3},100)},fixPath:function(){if(window.location.hash&&"#_=_"===window.location.hash){var t={top:document.body.scrollTop,left:document.body.scrollLeft};window.location.hash="",document.body.scrollTop=t.top,document.body.scrollLeft=t.left}}}),RB.App=Backbone.View.extend({el:".dmc",inputTemplate:_.template($("#input-template").html()),initialize:function(){this.fixPath(),this.get(),this.init(),this.renderInputFields()},events:{"click .lists-container .list-item":"renderList","click .create-list-btn":"createList","click .toggle-list-btn":"toggleLists","click .create-note-btn":"createNote","keyup .note-input":"createOnEnter","keyup .active-input":"validate","click .garbage-container":"removeAllDone","focus .list-input":"isMakingNewList","keyup .list-input":"compareListValue"},grabValueSnapshot:function(){if(this.isListSelected){var t=$(".list-input").val();return t}},isMakingNewList:function(){var t=this.getLists(),e=this.grabValueSnapshot();return e?(this.currentList=e,void(this.allLists=t)):!1},compareListValue:function(){var t=$(".list-input").val(),e=$(".active-notes-container");t!==this.currentList?(e.hide(),this.checkMatchingLists(t)):e.show()},checkMatchingLists:function(t){for(var e,i=$(".active-notes-container"),n=0;n<this.allLists.length;n++)t===this.allLists[n]&&(e=this.getNotesByListname(t),this.setNotes(i,e),i.show())},renderList:function(t){var e=$(t.currentTarget).data("id"),i=this.collection.where({list:e});this.setNotes(".active-notes-container",i),this.deviceEnv(400),this.onChangeListeners()},createList:function(){var t=$(".note-input"),e=$(".list-input"),i=$(".active-notes-container");t.val(""),e.val("").focus(),i.empty(),this.onChangeListeners()},renderInputFields:function(){return $(".active-list-container").html(this.inputTemplate()),this},createOnEnter:function(t){13===t.keyCode&&this.createNote()},validate:function(){var t=$(".note-input").val(),e=$(".list-input").val(),i=$(".create-note-btn .fa");t.trim()&&""!==e.trim()?i.addClass("ready"):i.removeClass("ready")},createNote:function(){var t=$(".note-input").val(),e=$(".list-input").val();if(t.trim()&&""!==e.trim()){var i=Date.now(),n=this.convertDate(i),s={body:t,list:e,created:i,timestamp:n,done:!1},o=this.collection.findWhere({body:s.body,list:s.list});if(o)return!1;this.post(s)}},removeAllDone:function(){if(this.isListSelected()){var t=$(".list-input").val(),e=this.collection.where({list:t,done:!0});return console.log(e),_.invoke(e,"destroy"),!1}}}),RB.NoteItem=Backbone.View.extend({className:"list-item",itemTemplate:_.template($("#note-item-template").html()),initalize:function(){this.listenTo(this.model,"destroy",this.remove),this.render()},events:{"click .edit .fa-trash":"destroyNote","click .edit .fa-check-square":"toggleDone","click .note-text":"positionCursor","blur .note-text":"updateNoteBody","keyup .note-text":"updateNoteOnEnter"},render:function(){return this.$el.html(this.itemTemplate(this.model.toJSON())),this},positionCursor:function(t){var e=$(t.currentTarget),i=e.val().length;return e.hasClass("busy")?!1:(e.addClass("busy"),void e[0].setSelectionRange(i,i+1))},destroyNote:function(){this.destroy(this.model),this.remove()},toggleDone:function(){var t=this.model.get("done"),e={done:!t};this.put(this.model,e,this)},updateNoteBody:function(t){var e=$(t.currentTarget),i=e.val().trim(),n={body:i};e.removeClass("busy"),this.put(this.model,n,this)},updateNoteOnEnter:function(t){var e=$(t.currentTarget);13===t.keyCode&&e.blur()}});var app=new RB.App;