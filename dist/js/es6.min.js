"use strict";var RB={};RB.User=Backbone.Model.extend({url:"/users",idAttribute:"_id"}),RB.Note=Backbone.Model.extend({idAttribute:"_id"}),RB.List=Backbone.Model.extend({idAttribute:"_id"}),RB.Lists=Backbone.Collection.extend({model:RB.List,url:"/notes"}),RB.Notes=Backbone.Collection.extend({model:RB.Note,url:"/notes",merge:!0}),_.extend(Backbone.View.prototype,{start:function(){app.user=new RB.User,app.helpers.init(),app.user.fetch({success:function(t,e){return null===app.user&&(app.user=t),null===app.listsCollection&&(app.listsCollection=new RB.Lists(t.attributes.lists),app.setLists(),app.setProgressBars()),app.listsCollection},error:function(t){console.log(t)}})},get:function(){var t=arguments.length<=0||void 0===arguments[0]?{render:!0,_id:!1}:arguments[0];app.user.fetch({success:function(e,i){app.listsCollection.stopListening(),app.listsCollection=new RB.Lists(e.attributes.lists),app.activeListId&&t.render?app.setNotes(app.activeListId):t._id?(app.activeListId=t._id,app.setActiveListId(app.activeListId),app.setLists(),app.setNotes(app.activeListId)):app.setLists(),app.setProgressBars(),console.log("GET: ",app.listsCollection)},error:function(t){console.log(t)}})},post:function(t){{var e=$(".note-input");$(".notes-container")}$.ajax({url:"/notes/",method:"POST",data:t,success:function(t,i){console.log("model ",t),console.log("response ",i),e.val("").focus(),app.validate(),app.notify(i),app.get({_id:t._id})},error:function(t){console.log(t)}})},put:function(t,e,i){var n=t.get("_id");t.save(e,{url:"/notes/"+n,success:function(t,e){app.notify("Updated"),app.get()},error:function(t){console.log("error ",t)}})},destroy:function(t){var e=t.get("_id"),i=app.getActiveListId();t.set("listId",i),null!==e&&t.destroy({url:"/notes/"+e+"?listId="+i,success:function(t,e){console.log("success ",t),app.notify("Removed"),app.get()},error:function(t){console.log("error ",t)}})},list:{destroy:function(t,e){null!==e&&t.destroy({url:"/lists/"+e,success:function(t,i){console.log("success ",t),app.removeListItemById(e),app.notify("Removed"),app.get({render:!1}),app.createList()},error:function(t){console.log("error ",t)}})}}}),_.extend(Backbone.View.prototype,{garbageTemplate:_.template($("#garbage-watcher-template").html()),allDoneTemplate:_.template($("#sunny-template").html()),setLists:function(){var t=$(".lists-container");t.empty(),app.listsCollection.each(function(e){var i=new RB.ListItem({model:e});t.append(i.render().el)})},setNote:function(t){var e=$(".notes-container"),i=new RB.NoteItem({model:t});e.append(i.render().el)},setNotes:function(t){{var e=app.listsCollection.get(t),i=new RB.Notes(e.attributes.notes),n=e.attributes.name,s=$(".notes-container"),o=$(".list-input");$(".note-input")}s.empty(),o.val(n),i.each(function(t){var e=new RB.NoteItem({model:t});s.append(e.render().el)}),null===app.activeListLength&&(app.activeListLength=i.length,console.log(app.activeListLength)),app.notesCollection=i,app.resetActiveList(n)},getActiveListId:function(){var t=app.activeListId;return t},setActiveListId:function(t){var e=$(".notes-container");return e.attr("data-list",t),app.activeListId=t,this},getListContainerById:function(t){var e=$(".list-item .inner-container");return e.find("[data-id='"+t+"']")},removeListItemById:function(t){var e=app.getListContainerById(t);e.parent().remove()},setListValue:function(t){var e=$(".list-input");e.val(t)},resetActiveList:function(t){var e=$(".list-item"),i=$("div").find("[data-id='"+t+"']");return e.removeClass("active"),i.addClass("active"),i},setProgressBars:function(){var t=[],e=0;app.listsCollection.each(function(i){var n=i.id,s=i.attributes.name,o=new RB.Notes(i.attributes.notes),a=o.length,l=o.where({done:!1}).length,r=a-l,c=l/a*100+"%",p=r/a*100+"%",d={name:s,_id:n,length:a,notDone:l,notDonePct:c,done:r,donePct:p};t.push(d),o.stopListening(),e++}),t.forEach(function(t){var e=$("div").find("[data-done='"+t._id+"']"),i=$("div").find("[data-notDone='"+t._id+"']");e.css({width:t.donePct}),i.css({width:t.notDonePct}),app.activeListId&&app.activeListId===t._id&&app.hasLengthChanged(t)})},animateListTotal:function(t){var e=$("div").find("[data-length='"+t._id+"']");e.removeClass("fadeInUp"),e.text(t.length),e.addClass("fadeOutUp"),setTimeout(function(){e.removeClass("fadeOutUp"),e.addClass("fadeInUp"),e.show()},300)},hasLengthChanged:function(t){return app.activeListLength===t.length?!1:(app.activeListLength=t.length,app.animateListTotal(t),!0)}}),_.extend(Backbone.View.prototype,{helpers:{init:function(){app.fixPath(),app.onClickSetActive(),app.isMobile(800)}},notify:function(t){var e=$(".kurt-loader");e.html('<p class="thin-sm animated fadeIn">'+t+"</p>");var i=e.find(".thin-sm");setTimeout(function(){i.removeClass("animated fadeIn"),i.addClass("animated fadeOut")},1e3)},tojquery:function(t){switch(typeof t){case"object":if(t instanceof jQuery)return t;break;case"string":return $("."===t.charAt(0)?t:document.getElementsByClassName(t))}},convertDate:function(t){var e=new Date(t),i=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],n=(e.getFullYear(),e.getMonth()),s=(""+(n+1)).slice(-2),o=e.getDate(),a=e.getHours(),l=e.getMinutes(),r=l>10?l:"0"+l,c=a>=12?"PM":"AM",p=a>12?a-12:a,d=0===p?12:p,u=i[e.getDay()]+" "+s+"/"+o+" "+d+":"+r+c;return u},onClickSetActive:function(){$(document).on("click",".lists-container .list-item",function(){var t=$(".list-item");t.removeClass("active"),$(this).addClass("active")})},toggleLists:function(){var t=$(".lists-container"),e=$(".toggle-list-btn .fa");t.slideToggle("fast"),e.toggleClass("collapsed")},isMobile:function(t){var e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return e&&setTimeout(this.toggleLists,t),e},fixPath:function(){if(window.location.hash&&"#_=_"===window.location.hash){var t={top:document.body.scrollTop,left:document.body.scrollLeft};window.location.hash="",document.body.scrollTop=t.top,document.body.scrollLeft=t.left}}}),RB.App=Backbone.View.extend({el:".dmc",inputTemplate:_.template($("#input-template").html()),user:null,listsCollection:null,notesCollection:null,activeListId:null,activeListLength:null,initialize:function(){this.renderInputFields()},events:{"click .create-list-btn":"createList","click .toggle-list-btn":"toggleLists","click .create-note-btn":"createNote","keyup .note-input":"createOnEnter","keyup .activeInput":"validate"},createList:function(){var t=$(".note-input"),e=$(".list-input"),i=$(".notes-container");t.val(""),e.val("").focus(),i.empty()},renderInputFields:function(){return $(".inputs-container").html(this.inputTemplate()),this},createOnEnter:function(t){13===t.keyCode&&app.createNote()},validate:function(){var t=$(".note-input").val(),e=$(".list-input").val(),i=$(".create-note-btn .fa");t.trim()&&""!==e.trim()?i.addClass("ready"):i.removeClass("ready")},createNote:function(){var t=$(".note-input").val(),e=$(".list-input").val(),i=!1;if(t.trim()&&""!==e.trim()){var n={body:t,list:e,done:i};if(app.listsCollection.length>0)for(var s=0;s<app.listsCollection.length;s++){var o=app.listsCollection.models[s].body;if(n.body===o)return!1}app.post(n)}return this}}),RB.ListItem=Backbone.View.extend({className:"list-item",listTemplate:_.template($("#list-name-template").html()),events:{"click .inner-container":"selected"},initialize:function(){this.render()},render:function(){return this.$el.html(this.listTemplate(this.model.toJSON())),this},selected:function(t){var e=$(t.currentTarget).data("id");this.setNotes(e),this.setActiveListId(e),this.isMobile(400)}}),RB.NoteItem=Backbone.View.extend({className:"note-item",itemTemplate:_.template($("#note-item-template").html()),attributes:{},initalize:function(){this.listenTo(this.model,"destroy",this.remove)},events:{"click .edit .fa-trash":"destroyNote","click .edit .fa-check-square":"toggleDone","click .note-text":"positionCursor","blur .note-text":"updateNoteBody","keyup .note-text":"updateNoteOnEnter"},render:function(){if(!this.model.get("timestamp")&&this.model.get("created")){var t=this.model.get("created");this.model.set("timestamp",this.convertDate(t))}else this.model.get("timestamp")||this.model.get("created")||this.model.set("timestamp",this.convertDate(new Date));return this.model.get("done")||this.model.set("done",!1),this.$el.html(this.itemTemplate(this.model.toJSON())),this},positionCursor:function(t){var e=$(t.currentTarget),i=e.val().length;return e.hasClass("busy")?!1:app.isMobile?!1:(e.addClass("busy"),void e[0].setSelectionRange(i,i+1))},destroyNote:function(){return console.log(app.activeListLength),1===app.activeListLength?(app.list.destroy(this.model,app.activeListId),!1):(this.destroy(this.model),void this.remove())},toggleDone:function(){var t=this.model.get("done"),e=this.getActiveListId(),i={done:!t,listId:e};this.put(this.model,i,this)},updateNoteBody:function(t){var e=$(t.currentTarget),i=e.val().trim(),n=this.getActiveListId(),s={body:i,listId:n};e.removeClass("busy"),this.put(this.model,s,this)},updateNoteOnEnter:function(t){var e=$(t.currentTarget);13===t.keyCode&&e.blur()}});var app=new RB.App;app.start();