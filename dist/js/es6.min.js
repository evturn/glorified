"use strict";var RB={};RB.User=Backbone.Model.extend({url:"/users",idAttribute:"_id"}),RB.Note=Backbone.Model.extend({idAttribute:"_id"}),RB.List=Backbone.Model.extend({idAttribute:"_id"}),RB.Lists=Backbone.Collection.extend({model:RB.List,url:"/notes"}),RB.Notes=Backbone.Collection.extend({model:RB.Note,url:"/notes",merge:!0}),_.extend(Backbone.View.prototype,{start:function(){app.renderForms(),app.user=new RB.User,app.listsCollection=null,app.notesCollection=null,app.activeListId=null,app.activeListLength=null,app.mobileClient=null,app.tabletClient=null,app.desktopClient=null,app.windowWidth=$(window).width(),app.$lists=$(".lists"),app.$notes=$(".notes"),app.$listInput=$(".list-input"),app.$noteInput=$(".note-input"),app.$notesContainer=$(".notes-container"),app.$listsContainer=$(".lists-container"),app.listeners.init(),app.user.fetch({success:function(t,e){return null===app.user&&(app.user=t),null===app.listsCollection&&(app.listsCollection=new RB.Lists(t.attributes.lists),app.setLists(),app.setProgressBars()),app.listsCollection},error:function(t){console.log(t)}})},get:function(){var t=arguments.length<=0||void 0===arguments[0]?{render:!0,_id:!1}:arguments[0];app.user.fetch({success:function(e,n){if(app.listsCollection.stopListening(),app.listsCollection=new RB.Lists(e.attributes.lists),t._id)app.activeListId=t._id,app.setActiveListId(app.activeListId),app.setLists();else if(t.render===!1)return app.setLists(),app.setProgressBars(),!1;app.setNotes(app.activeListId),app.setProgressBars()},error:function(t){console.log(t)}})},post:function(t){$.ajax({url:"/notes/",method:"POST",data:t,success:function(t,e){app.$noteInput.val("").focus(),app.validate(),app.notify(e),app.get({_id:t._id,render:!0})},error:function(t){console.log(t)}})},put:function(t,e,n){var a=t.get("_id");t.save(e,{url:"/notes/"+a,success:function(t,e){app.notify("Updated"),app.get()},error:function(t){console.log("error ",t)}})},destroy:function(t){var e=t.get("_id"),n=app.getActiveListId();t.set("listId",n),null!==e&&t.destroy({url:"/notes/"+e+"?listId="+n,success:function(t,e){console.log("success ",t),app.notify("Removed"),app.get()},error:function(t){console.log("error ",t)}})},list:{destroy:function(t,e){null!==e&&t.destroy({url:"/lists/"+e,success:function(t,n){console.log("success ",t),app.removeListItemById(e),app.notify("Removed"),app.get({render:!1}),app.createList()},error:function(t){console.log("error ",t)}})}}}),_.extend(Backbone.View.prototype,{getActiveListId:function(){var t=app.activeListId;return t},setActiveListId:function(t){return app.$notesContainer.attr("data-list",t),app.activeListId=t,this},getListContainerById:function(t){var e=$(".list-item .inner-container");return e.find("[data-id='"+t+"']")},removeListItemById:function(t){var e=app.getListContainerById(t);e.parent().remove()},setListValue:function(t){app.$listInput.val(t)},resetActiveList:function(t){var e=$(".list-item"),n=$("div").find("[data-id='"+t+"']");return e.removeClass("active"),n.addClass("active"),n},renderForms:function(){var t=$(".inputs-container");return t.html(this.inputTemplate()),autosize($("textarea")),this},renderActiveProgressBar:function(t){var e=app.notesCollection,n=$(".active-progress"),a=t,i=e.length,s=e.where({done:!1}).length,o=i-s,p=s/i*100+"%",l=parseInt(p).toFixed(0)+"%",r=o/i*100+"%",d=parseInt(r).toFixed(0)+"%",c={name:name,_id:a,length:i,notDone:s,notDonePct:p,notDoneText:l,done:o,donePct:r,doneText:d};0===n.children().length&&n.html(app.progressBarTemplate(c));var u=$("#list-progress").find("[data-done='"+c._id+"']"),m=$("#list-progress").find("[data-notDone='"+c._id+"']"),h=$(".not-done-text"),g=$(".done-text");u.css({width:c.donePct}),m.css({width:c.notDonePct}),g.html(c.doneText),h.html(c.notDoneText),app.activeListId&&app.activeListId===c._id&&app.hasLengthChanged(c)},setProgressBars:function(){var t=[],e=0;app.listsCollection.each(function(n){var a=n.id,i=n.attributes.name,s=new RB.Notes(n.attributes.notes),o=s.length,p=s.where({done:!1}).length,l=o-p,r=p/o*100+"%",d=l/o*100+"%",c={name:i,_id:a,length:o,notDone:p,notDonePct:r,done:l,donePct:d};t.push(c),s.stopListening(),e++}),t.forEach(function(t){var e=$("div").find("[data-done='"+t._id+"']"),n=$("div").find("[data-notDone='"+t._id+"']");e.css({width:t.donePct}),n.css({width:t.notDonePct}),app.activeListId&&app.activeListId===t._id&&app.hasLengthChanged(t)})},tojquery:function(t){switch(typeof t){case"object":if(t instanceof jQuery)return t;break;case"string":return $("."===t.charAt(0)?t:document.getElementsByClassName(t))}},convertDate:function(t){var e=new Date(t),n=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],a=(e.getFullYear(),e.getMonth()),i=(""+(a+1)).slice(-2),s=e.getDate(),o=e.getHours(),p=e.getMinutes(),l=p>10?p:"0"+p,r=o>=12?"pm":"am",d=o>12?o-12:o,c=0===d?12:d,u=i+"/"+s+" "+c+":"+l+r+" "+n[e.getDay()];return u}}),_.extend(Backbone.View.prototype,{mobile:{init:function(){app.setMobile()}},isMobile:function(){var t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return t},setMobile:function(){var t=$("body");t.addClass("mobile")}}),_.extend(Backbone.View.prototype,{listeners:{init:function(){app.fixPath(),app.readClient(),app.setClient(),app.isMobile(),autosize(document.querySelectorAll("textarea")),$(window).resize(function(){app.windowWidth=$(window).width(),app.setClient()}),$(document).on("click",".lists-container .list-item",function(){var t=$(".list-item");t.removeClass("active"),$(this).addClass("active")}),$(document).on("click",".toggle-list-btn",function(){app.toggleLists()}),$(document).on("click",".active-progress",function(){$(".active-progress").toggleClass("show-details")})}},readClient:function(){app.isMobile()?(app.mobileClient=!0,app.mobile.init()):app.mobileClient=!1,app.windowWidth<800&&app.windowWidth>600?(app.tabletClient=!0,app.desktopClient=!1):app.windoWidth>=800&&(app.tabletClient=!1,app.desktopClient=!0)},setClient:function(){app.windowWidth>600?(app.$notes.removeClass("expanded"),app.$notes.removeClass("collapsed"),app.$lists.removeClass("expanded"),app.$lists.removeClass("collapsed"),app.stopAnimation()):(app.$notes.addClass("expanded"),app.$lists.addClass("collapsed"),app.animateContainers())},toggleLists:function(){arguments.length<=0||void 0===arguments[0]?{reset:!1}:arguments[0];app.$lists.toggleClass("collapsed"),app.$lists.toggleClass("expanded"),app.$notes.toggleClass("expanded"),app.$notes.toggleClass("collapsed"),app.windowWidth<600?app.animateContainers():app.stopAnimation()},animateContainers:function(){app.$lists.hasClass("collapsed")&&app.$notes.hasClass("expanded")?(app.$lists.animate({marginLeft:"-42%"},200),app.$notes.animate({marginRight:"0%"},200)):app.$lists.hasClass("expanded")&&app.$notes.hasClass("collapsed")&&(app.$notes.animate({marginRight:"-45%"},200),app.$lists.animate({marginLeft:"0%"},200))},stopAnimation:function(){app.$notes.animate({marginRight:"0%"},30),app.$lists.animate({marginLeft:"0%"},30)},notify:function(t){var e=$(".kurt-loader .message");e.html(t),e.removeClass("animated fadeOut"),e.addClass("animated fadeIn"),setTimeout(function(){e.removeClass("animated fadeIn"),e.addClass("animated fadeOut")},1e3)},fixPath:function(){if(window.location.hash&&"#_=_"===window.location.hash){var t={top:document.body.scrollTop,left:document.body.scrollLeft};window.location.hash="",document.body.scrollTop=t.top,document.body.scrollLeft=t.left}},animateListTotal:function(t){var e=$("div").find("[data-length='"+t._id+"']");e.removeClass("fadeInUp"),e.text(t.length),e.addClass("fadeOutUp"),setTimeout(function(){e.removeClass("fadeOutUp"),e.addClass("fadeInUp"),e.show()},300)},hasLengthChanged:function(t){return app.activeListLength===t.length?!1:(app.activeListLength=t.length,app.animateListTotal(t),!0)}}),RB.App=Backbone.View.extend({el:".dmc",inputTemplate:_.template($("#input-template").html()),progressBarTemplate:_.template($("#progress-bar-template").html()),events:{"click .create-list-btn":"createList","click .create-note-btn":"createNote","keyup .note-input":"createOnEnter","keyup .activeInput":"validate"},createNote:function(){var t=app.$noteInput.val(),e=app.$listInput.val(),n=!1;if(t.trim()&&""!==e.trim()){var a={body:t,list:e,done:n};if(app.listsCollection.length>0)for(var i=0;i<app.listsCollection.length;i++){var s=app.listsCollection.models[i].body;if(a.body===s)return!1}app.post(a)}return this},createList:function(){var t=$(".active-progress");app.$noteInput.val(""),app.$listInput.val("").focus(),app.activeListId=null,app.$notesContainer.empty(),t.empty(),app.$notesContainer.attr("data-list","")},createOnEnter:function(t){13===t.keyCode&&app.createNote()},validate:function(){var t=app.$noteInput.val(),e=app.$listInput.val(),n=$(".create-note-btn .fa");t.trim()&&""!==e.trim()?n.addClass("ready"):n.removeClass("ready")},setLists:function(){app.$listsContainer.empty(),app.listsCollection.each(function(t){var e=new RB.ListItem({model:t});app.$listsContainer.append(e.render().el)})},setNote:function(t){var e=new RB.NoteItem({model:t});app.$notesContainer.append(e.render().el)},setNotes:function(t){var e=app.listsCollection.get(t),n=app.sortNotes(e.attributes.notes),a=new RB.Notes(n),i=e.attributes.name;app.$notesContainer.empty(),app.$listInput.val(i),a.each(function(t){var e=new RB.NoteItem({model:t});app.$notesContainer.append(e.render().el)}),null===app.activeListLength&&(app.activeListLength=a.length),app.notesCollection=a,app.resetActiveList(i),app.renderActiveProgressBar(t)},sortNotes:function(t){var e=_.sortBy(t,"done");return e}}),RB.ListItem=Backbone.View.extend({className:"list-item",listTemplate:_.template($("#list-name-template").html()),events:{"click .inner-container":"selected"},initialize:function(){this.render()},render:function(){return this.$el.html(this.listTemplate(this.model.toJSON())),this},selected:function(t){var e=$(t.currentTarget).data("id"),n=$(".active-progress");n.empty(),app.setNotes(e),app.setActiveListId(e)}}),RB.NoteItem=Backbone.View.extend({className:"note-item",itemTemplate:_.template($("#note-item-template").html()),attributes:{},initalize:function(){this.listenTo(this.model,"destroy",this.remove)},events:{"click .edit .fa-trash":"destroyNote","click .edit .fa-check-square":"toggleDone","click .note-text":"positionCursor","blur .note-text":"updateNoteBody","keyup .note-text":"updateNoteOnEnter"},render:function(){if(!this.model.get("timestamp")&&this.model.get("created")){var t=this.model.get("created");this.model.set("timestamp",this.convertDate(t))}else this.model.get("timestamp")||this.model.get("created")||this.model.set("timestamp",this.convertDate(new Date));return this.model.get("done")||this.model.set("done",!1),this.$el.html(this.itemTemplate(this.model.toJSON())),autosize($("textarea")),$("textarea").css({resize:"none"}),this},positionCursor:function(t){var e=$(t.currentTarget),n=e.val().length;return app.isMobile?!1:e.hasClass("busy")?!1:(e.addClass("busy"),void e[0].setSelectionRange(n,n+1))},destroyNote:function(){return 1===app.activeListLength?(app.list.destroy(this.model,app.activeListId),!1):(app.destroy(this.model),void this.remove())},toggleDone:function(){var t=this.model.get("done"),e=this.getActiveListId(),n={done:!t,listId:e};app.put(this.model,n,this)},updateNoteBody:function(t){var e=$(t.currentTarget),n=e.val().trim(),a=this.getActiveListId(),i={body:n,listId:a};e.removeClass("busy"),app.put(this.model,i,this)},updateNoteOnEnter:function(t){var e=$(t.currentTarget);13===t.keyCode&&e.blur()}});var app=new RB.App;app.start();