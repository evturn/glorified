var RB={};RB.Note=Backbone.Model.extend({idAttribute:"_id"}),RB.Notes=Backbone.Collection.extend({model:RB.Note,url:"/notes",merge:!0}),RB.List=Backbone.Collection.extend({model:RB.Note,url:"/notes",merge:!0}),RB.init=function(){RB.fixPath();new RB.App;RB.get(),RB.e.init()},RB.get=function(){var e=new RB.Notes;e.fetch({success:function(e){RB.collection=e;var t=RB.getLists(RB.collection);RB.setLists(RB.collection,t)},error:function(e){console.log(e)}})},RB.reset=function(e){var t=RB.collection;t.fetch({success:function(t){var n=RB.getLists(t),i=t.where({list:e});RB.setLists(t,n),RB.setNotes(".active-notes-container",i)},error:function(e){console.log(e)}})},RB.getLists=function(e){var t=[];return e.each(function(e){var n=e.get("list");-1===t.indexOf(n)&&t.push(n)}),t},RB.setLists=function(e,t){var n=t,i=_.template($("#list-name-template").html()),o=$(".lists-container");o.empty();for(var s=0;s<n.length;s++){{var c=e.where({list:n[s]});new RB.Input}o.append(i({name:n[s],length:c.length}))}},RB.setNotes=function(e,t){var n=$(".active-notes-container"),i=$(".active-input.list-input"),o=$(".active-input.note-input");if(t.length>0){var s=t[0].get("list");i.val(s),$selector=RB.tojquery(e),$selector.empty();for(var c=0;c<t.length;c++){var l=t[c],a=new RB.NoteItem({model:l});$selector.append(a.render().el)}RB.resetActiveList(s),RB.e.isMobile()||o.focus()}else i.val(""),o.val(""),n.empty(),RB.e.isMobile()||o.focus()},RB.setNote=function(e){console.log(e);var t=$(".active-notes-container"),n=new RB.NoteItem({model:e});t.append(n.render().el)},RB.notify=function(e){$(".kurt-loader")},RB.fixPath=function(){if(window.location.hash&&"#_=_"===window.location.hash){var e={top:document.body.scrollTop,left:document.body.scrollLeft};window.location.hash="",document.body.scrollTop=e.top,document.body.scrollLeft=e.left}},RB.tojquery=function(e){switch(typeof e){case"object":if(e instanceof jQuery)return e;break;case"string":return $("."===e.charAt(0)?e:document.getElementsByClassName(e))}},RB.convertDate=function(e){var t=new Date(e),n=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],i=(t.getFullYear(),t.getMonth()),o=t.getDate(),s=t.getHours(),c=t.getMinutes(),l=c>10?c:"0"+c,a=s>=12?"PM":"AM",r=s>12?s-12:s;i=(""+(i+1)).slice(-2);var u=n[t.getDay()]+" "+i+"/"+o+" "+r+":"+l+a;return u},RB.resetActiveList=function(e){var t=$("div").find("[data-id='"+e+"']");t.addClass("active")},RB.post=function(){var e=$(".note-input"),t=$(".list-input").val(),n=Date.now(),i=RB.convertDate(n),o={body:e.val(),list:t,created:n,timestamp:i,done:!1};return RB.collection.findWhere({body:o.body})&&RB.collection.findWhere({list:o.list})?!1:void RB.collection.create(o,{success:function(n){RB.setNote(n),RB.reset(t),e.focus()},error:function(e){console.log(e)}})},RB.put=function(e){var t=e.get("list");e.save(null,{success:function(e){RB.collection.set(e),RB.reset(t),RB.notify("Updated")}})},RB.destroy=function(e){var t=e.get("list");e.destroy({success:function(e){RB.reset(t),RB.notify("Note deleted")},error:function(e){RB.reset(t),RB.notify("Removed")}})},RB.e={init:function(){RB.e.setActiveList(),RB.e.deviceEnv(),$(document).on("click",".toggle-list-btn",function(){RB.e.toggleLists()})},deviceEnv:function(){var e=$(".lists-container"),t=$(".toggle-list-btn .fa");RB.e.isMobile()&&(e.slideToggle("fast"),t.toggleClass("collapsed"))},setActiveList:function(){$(document).on("click",".lists-container .list-item",function(){var e=$(".list-item");e.removeClass("active"),$(this).addClass("active")})},toggleLists:function(){var e=$(".lists-container"),t=$(".toggle-list-btn .fa");e.slideToggle("fast"),t.toggleClass("collapsed")},isMobile:function(){var e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return e}},RB.App=Backbone.View.extend({el:".dmc",events:{"click .lists-container .list-item":"renderList","click .create-list-btn":"createList"},renderList:function(e){var t=$(e.currentTarget).data("id"),n=RB.collection.where({list:t});RB.setNotes(".active-notes-container",n),RB.e.isMobile()&&RB.e.toggleLists()},createList:function(){var e=$(".note-input"),t=$(".list-input"),n=$(".active-notes-container");e.val(""),t.val("").focus(),n.empty()}}),RB.Input=Backbone.View.extend({el:".active-list-container",inputTemplate:_.template($("#input-template").html()),initialize:function(){this.render()},events:{"click .create-note-btn":"createNote","keyup .note-input":"createOnEnter","keyup .active-input":"validate"},render:function(){return $(".active-list-container").html(this.inputTemplate()),this},createOnEnter:function(e){13===e.keyCode&&this.createNote()},validate:function(){var e=$(".note-input").val(),t=$(".list-input").val(),n=$(".create-note-btn .fa");e.trim()&&""!==t.trim()?n.addClass("ready"):n.removeClass("ready")},createNote:function(){var e=$(".note-input"),t=$(".list-input"),n=e.val(),i=t.val();n.trim()&&""!==i.trim()&&RB.post()}}),RB.NoteItem=Backbone.View.extend({className:"list-item",itemTemplate:_.template($("#note-item-template").html()),initalize:function(){this.render()},events:{"click .edit .fa-trash":"destroyNote","click .edit .fa-check-square":"toggleDone"},render:function(){return this.$el.html(this.itemTemplate(this.model.toJSON())),this},destroyNote:function(){RB.destroy(this.model)},toggleDone:function(){var e=this.model,t=e.get("done");e.set(t?{done:!1}:{done:!0}),RB.put(e)}}),RB.init();